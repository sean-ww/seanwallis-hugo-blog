<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8" />

  
  <title>Testing Time</title>

  
  





<meta name="author" content="Sean Wallis" />
<meta name="description" content="Sometimes when unit testing PHP code, we run into things that are difficult to mock. This post will introduce how you can mock built-in php functions such as time() and mt_rand().
Mocking time() Let&amp;rsquo;s take the below example:
namespace Example\Namespace; function displayGreeting() { $time = time(); $hour = date(&amp;#34;g&amp;#34;, $time); $meridiem = date(&amp;#34;A&amp;#34;, $time); if ($meridiem == &amp;#34;AM&amp;#34;) { return &amp;#39;Good Morning&amp;#39;; } if ($hour &amp;lt;= 6 || $hour == 12) { return &amp;#39;Good Afternoon&amp;#39;; } return &amp;#39;Good Evening&amp;#39;; } In order to fully test our display greeting function we need to be able to manipulate the time element, without having to change any system settings.
" />



<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@seanwallisuk" />
<meta name="twitter:title" content="Testing Time" />
<meta name="twitter:description" content="Sometimes when unit testing PHP code, we run into things that are difficult to mock. This post will introduce how you can mock built-in php functions such as time() and mt_rand().
Mocking time() Let&amp;rsquo;s take the below example:
namespace Example\Namespace; function displayGreeting() { $time = time(); $hour = date(&amp;#34;g&amp;#34;, $time); $meridiem = date(&amp;#34;A&amp;#34;, $time); if ($meridiem == &amp;#34;AM&amp;#34;) { return &amp;#39;Good Morning&amp;#39;; } if ($hour &amp;lt;= 6 || $hour == 12) { return &amp;#39;Good Afternoon&amp;#39;; } return &amp;#39;Good Evening&amp;#39;; } In order to fully test our display greeting function we need to be able to manipulate the time element, without having to change any system settings.
" />
<meta name="twitter:image" content="http://seanwallis.com/img/avatar.jpg" />





<meta name="generator" content="Hugo 0.32.4" />


<link rel="canonical" href="http://seanwallis.com/post/testing-time/" />
<link rel="alternative" href="http://seanwallis.com/index.xml" title="Sean Wallis" type="application/atom+xml" />


<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="format-detection" content="telephone=no,email=no,adress=no" />
<meta http-equiv="Cache-Control" content="no-transform" />


<meta name="robots" content="index,follow" />
<meta name="referrer" content="origin-when-cross-origin" />







<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Sean Wallis" />
<meta name="msapplication-tooltip" content="Sean Wallis" />
<meta name='msapplication-navbutton-color' content="#2576c0" />
<meta name="msapplication-TileColor" content="#2576c0" />
<link rel="icon" href="http://seanwallis.com/img/favicon.ico" />
<link rel="apple-touch-icon" href="http://seanwallis.com/img/apple-touch-icon.png" />
<link rel="apple-touch-icon" sizes="72x72" href="http://seanwallis.com/img/apple-touch-icon-72x72.png" />
<link rel="apple-touch-icon" sizes="114x114" href="http://seanwallis.com/img/apple-touch-icon-114x114.png" />



<link rel="stylesheet" href="//cdn.bootcss.com/video.js/6.2.8/alt/video-js-cdn.min.css" />

<link rel="stylesheet" href="http://seanwallis.com/css/bundle.css" />


<link rel="stylesheet" href="http://seanwallis.com/css/highlight/zenburn.css" />
<script rel="text/javascript" src="http://seanwallis.com/js/highlight.pack.js" ></script>
<script> hljs.initHighlightingOnLoad();</script>


  
  <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <script src="//cdn.bootcss.com/video.js/6.2.8/ie8/videojs-ie8.min.js"></script>
  <![endif]-->

<!--[if lte IE 11]>
    <script src="//cdn.bootcss.com/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->


<script src="//cdn.bootcss.com/object-fit-images/3.2.3/ofi.min.js"></script>


<script src="//cdn.bootcss.com/smooth-scroll/12.1.4/js/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
        <a title="Go to comments" class="to-comment" href="#disqus_thread"><span class="icon icon-comment"></span></a>
        
      
    </div>
    
    
<header class="site-header">
    <a href="http://seanwallis.com/" title="Home">
        <img class="avatar" src="http://seanwallis.com/media/links/profile.jpg" alt="Avatar">
    </a>
    
    <h2 class="title">Sean Wallis</h2>
    
    <p class="subtitle">Full Stack Developer @Enrise.
PHP. JavaScript. React.</p>
    
    
    
    
    
    
    
    
    
    
    
    
    <nav class="social-menu">
        <ul class="social-list">

            

            
            <li class="social-item">
                <a href="//github.com/sean-ww" title="GitHub"><span class="icon icon-github"></span></a>
            </li>

            <li class="social-item">
            <a href="//twitter.com/seanwallisuk" title="Twitter"><span class="icon icon-twitter"></span></a>
        </li>

            

            

            

            

            

            

            

            

            

            

            

            

            

            

            <li class="social-item">
            <a href="//www.linkedin.com/in/seanwallis1" title="Linkedin"><span class="icon icon-linkedin"></span></a>
        </li>

            

            

            

            
            
            

        </ul>
    </nav>
</header>

<section class="main post-detail">
  <header class="post-header">
    <h1 class="post-title">Testing Time</h1>
    <span class="post-meta">@Sean Wallis · Nov 2, 2017 · 3 min read</span>
    <nav class="social-menu" style="display: inline-block;">
    <ul class="social-list">

        <li class="social-item">
            
                <a href="//twitter.com/intent/tweet?text=Unit%20testing%20with%20built-in%20PHP%20functions&url=http%3a%2f%2fseanwallis.com%2fpost%2ftesting-time%2f" title="Share on Twitter"><span class="icon icon-twitter"></span></a>
            
        </li>

        <li class="social-item">
            <a href="//www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fseanwallis.com%2fpost%2ftesting-time%2f" title="Share on Facebook"><span class="icon icon-facebook"></span></a>
        </li>

        <li class="social-item">
            <a href="//www.linkedin.com/shareArticle?mini=true&title=Testing%20Time&url=http%3a%2f%2fseanwallis.com%2fpost%2ftesting-time%2f" title="Share on Linkedin"><span class="icon icon-linkedin"></span></a>
        </li>

    </ul>
</nav>

  </header>
  <article class="post-content"><p>Sometimes when unit testing PHP code, we run into things that are difficult to mock. This post will introduce how you can mock built-in php functions such as time() and mt_rand().</p>

<h2 id="mocking-time">Mocking time()</h2>

<p>Let&rsquo;s take the below example:</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="x">namespace Example\Namespace;
</span><span class="x">
</span><span class="x">function displayGreeting()
</span><span class="x">{
</span><span class="x">    $time = time();
</span><span class="x">    $hour = date(&#34;g&#34;, $time);
</span><span class="x">    $meridiem = date(&#34;A&#34;, $time);
</span><span class="x">    if ($meridiem == &#34;AM&#34;) {
</span><span class="x">        return &#39;Good Morning&#39;;
</span><span class="x">    }
</span><span class="x">    if ($hour &lt;= 6 || $hour == 12) {
</span><span class="x">        return &#39;Good Afternoon&#39;;
</span><span class="x">    }
</span><span class="x">    return &#39;Good Evening&#39;;
</span><span class="x">}</span></code></pre></div>
<p>In order to fully test our display greeting function we need to be able to manipulate the time element, without having to change any system settings.</p>

<p>We could just pass in the time as a dependency and mock that. However, by overriding built-in functions within a namespace we can avoid this:</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="x">namespace Example\Namespace;
</span><span class="x">
</span><span class="x">class DisplayGreetingTest extends \PHPUnit_Framework_TestCase
</span><span class="x">{
</span><span class="x">    use \phpmock\phpunit\PHPMock;
</span><span class="x">
</span><span class="x">    /**
</span><span class="x">     * @param string $timeString     The time value hh:mm.
</span><span class="x">     * @param string $expectedResult The expected result.
</span><span class="x">     *
</span><span class="x">     * @dataProvider providerTestDisplayGreeting
</span><span class="x">     */
</span><span class="x">    public function testDisplayGreeting($timeString, $expectedResult)
</span><span class="x">    {
</span><span class="x">        // Mock time
</span><span class="x">        $time = $this-&gt;getFunctionMock(__NAMESPACE__, &#34;time&#34;);
</span><span class="x">        $time-&gt;expects($this-&gt;once())-&gt;willReturn(strtotime($timeString));
</span><span class="x">
</span><span class="x">        $result = displayGreeting();
</span><span class="x">        $this-&gt;assertEquals($expectedResult, $result);
</span><span class="x">    }
</span><span class="x">
</span><span class="x">    public function providerTestDisplayGreeting()
</span><span class="x">    {
</span><span class="x">        return array(
</span><span class="x">            &#39;Good Morning&#39; =&gt; array(
</span><span class="x">                &#39;00:00&#39;,
</span><span class="x">                &#39;Good Morning&#39;
</span><span class="x">            ),
</span><span class="x">            &#39;Good Morning&#39; =&gt; array(
</span><span class="x">                &#39;11:59&#39;,
</span><span class="x">                &#39;Good Morning&#39;
</span><span class="x">            ),
</span><span class="x">            &#39;Good Afternoon&#39; =&gt; array(
</span><span class="x">                &#39;12:00&#39;,
</span><span class="x">                &#39;Good Afternoon&#39;
</span><span class="x">            ),
</span><span class="x">            &#39;Good Afternoon&#39; =&gt; array(
</span><span class="x">                &#39;17:59&#39;,
</span><span class="x">                &#39;Good Afternoon&#39;
</span><span class="x">            ),
</span><span class="x">            &#39;Good Evening&#39; =&gt; array(
</span><span class="x">                &#39;18:00&#39;,
</span><span class="x">                &#39;Good Evening&#39;
</span><span class="x">            ),
</span><span class="x">            &#39;Good Evening&#39; =&gt; array(
</span><span class="x">                &#39;23:59&#39;,
</span><span class="x">                &#39;Good Evening&#39;
</span><span class="x">            )
</span><span class="x">        );
</span><span class="x">    }
</span><span class="x">}</span></code></pre></div>
<p>In the above example we can make use of the <a href="https://github.com/php-mock/php-mock-phpunit">php-mock/php-mock-phpunit</a> to get a function mock, and then alter what the function returns in each of our test provider test cases.</p>

<p>We can then apply the same idea to other built-in php functions.</p>

<h2 id="mocking-mt-rand">Mocking mt_rand()</h2>

<p>Let&rsquo;s look at another example:</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="x">namespace Example\Namespace;
</span><span class="x">
</span><span class="x">function generateRandomString($randomStringLength = 20)
</span><span class="x">{
</span><span class="x">    $randomString = &#39;&#39;;
</span><span class="x">    $possibleCharacters = &#39;2346789bcdfghjkmnpqrtvwxyzBCDFGHJKLMNPQRTVWXYZ&#39;;
</span><span class="x">
</span><span class="x">    $iteration = 0;
</span><span class="x">    while ($iteration &lt; $randomStringLength) {
</span><span class="x">        $character = substr($possibleCharacters, mt_rand(0, $randomStringLength - 1), 1);
</span><span class="x">        if (!strstr($randomString, $character)) {
</span><span class="x">            $randomString .= $character;
</span><span class="x">            $iteration++;
</span><span class="x">        }
</span><span class="x">    }
</span><span class="x">
</span><span class="x">    return $randomString;
</span><span class="x">}</span></code></pre></div>
<p>The above function is using mt_rand to select characters at random from a possible character list. However, in order to test assertions, we need to make the random element deterministic.</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="x">namespace Example\Namespace;
</span><span class="x">
</span><span class="x">class GenerateRandomStringTest extends \PHPUnit_Framework_TestCase
</span><span class="x">{
</span><span class="x">    use \phpmock\phpunit\PHPMock;
</span><span class="x">
</span><span class="x">    public function testGenerateRandomString()
</span><span class="x">    {
</span><span class="x">        // Mock mt_rand
</span><span class="x">        $mt_rand = $this-&gt;getFunctionMock(__NAMESPACE__, &#34;mt_rand&#34;);
</span><span class="x">        $i = 0;
</span><span class="x">        while ($i &lt; 20) {
</span><span class="x">            $mt_rand-&gt;expects($this-&gt;at($i))-&gt;willReturn($i);
</span><span class="x">            $i++;
</span><span class="x">        }
</span><span class="x">
</span><span class="x">        $result = generateRandomString();
</span><span class="x">        $expectedResult = &#39;2346789bcdfghjkmnpqr&#39;;
</span><span class="x">        $this-&gt;assertEquals($expectedResult, $result);
</span><span class="x">    }
</span><span class="x">}</span></code></pre></div>
<p>As before, we can get a mock of the function and then control what it returns each time it is called. The above test could then be expanded to test different patterns of random numbers, or different lengths of string.</p></article>
  <footer class="post-footer">
    <nav class="social-menu" style="display: inline-block;">
    <ul class="social-list">

        <li class="social-item">
            
                <a href="//twitter.com/intent/tweet?text=Unit%20testing%20with%20built-in%20PHP%20functions&url=http%3a%2f%2fseanwallis.com%2fpost%2ftesting-time%2f" title="Share on Twitter"><span class="icon icon-twitter"></span></a>
            
        </li>

        <li class="social-item">
            <a href="//www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fseanwallis.com%2fpost%2ftesting-time%2f" title="Share on Facebook"><span class="icon icon-facebook"></span></a>
        </li>

        <li class="social-item">
            <a href="//www.linkedin.com/shareArticle?mini=true&title=Testing%20Time&url=http%3a%2f%2fseanwallis.com%2fpost%2ftesting-time%2f" title="Share on Linkedin"><span class="icon icon-linkedin"></span></a>
        </li>

    </ul>
</nav>

    
    <p class="post-copyright">
      This post was published <strong>793</strong> days ago, content in the post may be inaccurate, even wrong now, please take risk yourself.
    </p>
  </footer>
  
  <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "seanwallis" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  
  
</section>
<footer class="site-footer">
  <p>© 2017-2020 Sean Wallis</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/sean-ww/hugo-nuo" target="_blank">Nuo</a>.</p>
  
</footer>



<script async src="//cdn.bootcss.com/video.js/6.2.8/alt/video.novtt.min.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\[','\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>

<script src="http://seanwallis.com/js/bundle.js"></script>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-XXXXXXXX-X', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>





  </body>
</html>
